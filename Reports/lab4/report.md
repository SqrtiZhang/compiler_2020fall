# Lab4 实验报告

小组成员：

闫超美 PB18061351

张永停 PB17111585

## 实验要求

1. 理解框架代码与 Cminusf 的语义，填写使用访问者模式的 `src/cminusf/cminusf_builder.cpp`，使编译出的 `cminusf` 可以编译 Cminusf 程序到 LLVM IR 或可执行文件。
2. 编写测试样例，确保在源程序符合 Cminusf 语义的情况下，`cminusf` 可以得到正确的结果。

## 实验难点

* 对访问者模式的理解，以及研究框架，要清楚流程就是访问AST来生成中间代码，在访问不同的节点时生成对应的代码，最终访问完后要能生成正确的LLVM IR。
* 全局变量的选择，不同的函数之间是有变量的传递的，这部分的传递一是可以在scope里做，当它们在同一个作用域里。也可以使用全局变量，保存访问前面的节点时需要传递的信息，比如当有多个函数的时候，会访问很多次Funcdeclaration节点，所以每次都要用一个全局变量来保存函数信息，表明是当前是在哪个函数里面，之后的选择和循环插入标签时就需要用到。
* 作用域问题，要搞清楚在哪里enter scope，在哪里退出scope。
* return的处理，比如在while和if里出现了return，那么这时候就不能再br了，不然可能会导致执行时寄存器编号出错。
* 类型转换，float当成int输入时需要自己对它做类型转换。
* 数组传参，数组传参要转化成指针传入。而且确定在什么时候转换比较难搞。
* 数组下标为负数时的检测。要在每一次遇到数组索引的情况都判断一次。

## 实验设计

### 全局变量设计

实际用于传递中间值的全局变量只有一个 `Value *current_value`，还有一些其他类型的数据需要传递，所以加入了更多的全局变量。

1. current_value





### 难点的解决方案



### 降低生成IR的冗余




### 实验总结

* 闫超美：学到了很多cpp的语法，以及对面向对象编程有了更加深入的理解，尤其是对访问者模式在生成中间代码的妙用有很大的触动，没有想到设计模式在写这种比较大的项目中带来的巨大的优势。同时对LightIR这个框架有了更多的了解，处理生成中间代码需要考虑到的边边角角的问题的能力有所提升。

### 实验反馈 （可选 不会评分）

对本次实验的建议

### 组间交流 （可选）

本次实验和哪些组（记录组长学号）交流了哪一部分信息

