# Lab5 实验报告

闫超美 PB18061351

张永停 PB17111585

## 实验要求

开发基本pass：

1. 常量传播
2. 循环不变式外提
3. 活跃变量分析

## 实验难点

### 常量传播

1. 全局变量的处理，在处理全局变量时，一开始没有找到方法去处理，后来想了想，只有在遇到`load`语句时有可能是从全局变量取值，而一个全局变量在使用前会给它赋值，所以在load这个全局变量之前会先在之前`store`一个值进去，所以我们就可以通过维护一个`map`来在store的时候将全局变量与常值映射，然后在load的时候可以从这个map里把值查出来，然后把用到此变量的指令的操作数都替代为这个常值。
2. 判断是否是全局变量，一开始想找API，但是似乎没有，然后想到可以用`dynamic_cast<GlobalVariable *>`来判断是否是全局变量。
3. 遇到类型转换的处理，比如遇到fp2si指令和si2fp指令，需要手动做类型转换，并做常量传播，然后把这条指令给删除；一开始我忘记做这样的处理，导致优化效果没有那么理想。
4. 遇到零扩展指令`zext`的处理，这里是一个比较坑的点，因为在从i1到i32的扩展中，就有可能由于做扩展的变量是一个常量，从而被之前的常量传播所替代了，导致这条语句运行出错。如果不做这个处理的话是通不过测试的。由于一般zext是和cmp指令配套出现的，所以我也就在做cmp指令的常量传播时做了个判断，如果是zext指令，就要把zext也做一个常量传播，然后再将zext指令给删除掉。



### 循环不变式外提

1. 循环不变式外提后插入的位置要在br前，我之前尝试先把br删掉，然后插入后再生成br，可是这样会导致segmentation fault而且一直解决不了，索性换了个方法，直接用add_instr_begin 这个API将指令倒序插入到bb的开头。
2. 保存循环不变式的容器选择，一开始是用的vector存pair，每个pair是bb*和ins\*对应，然后发现这样在之后外提的时候想要从bb*对应的instr列表里删除这个instr会比较困难，因为有可能会有重合的语句，从而我改成了每个pair时bb和指向ins*的迭代器相对应，这样一来就可以直接通过迭代器去删除对应的语句。



### 活跃变量分析



## 实验设计

* 常量传播
  
    
  
    实现思路：
    
    ```txt
    
    ```
    
    
    
    相应代码：
    
    
    
    优化前后的IR对比（举一个例子）并辅以简单说明：
    
    




* 循环不变式外提
    实现思路：
    相应代码：
    优化前后的IR对比（举一个例子）并辅以简单说明：
    
* 活跃变量分析
    实现思路：
    相应的代码：

### 实验总结

**闫超美：**

​	

### 实验反馈 （可选 不会评分）

对本次实验的建议

### 组间交流 （可选）

本次实验和哪些组（记录组长学号）交流了哪一部分信息
